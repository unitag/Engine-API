API Reference
=============

## Introduction

TODO:
 - Lien vers API.md
 - Notions générales
     + [ ] Lien vers la doc de l'API
     + [ ] Publication
     + [ ] Structure des URL d'accès aux opération publiées

A intégrer :

```
       +--> Targets an operation <-+
       |                           |
http://:resolverHost[/:pathPrefix]/:resolverName/:entryPoint
                      |                          |
                      +--> Fixed by the host     +--> Targets an entry point
```

Exemples à placer aux bons endroits :

```javascript
{
    "url": {
        "host": "opn.to",
        "name": "test"
    },
    "state": "PUBLISHED",
    "index": {
        "json": {
            "body": "Here is the index step"
        }
    },
    "entryPoints": {
        "foobar": {
            "json": {
                "body": "Here is the foobar step"
            }
        }
    }
}
```

## The `Operation` object

An `Operation` is a standalone document describing an HTTP application. It is expressed as a JSON object, which allows to specify:
 - how the application can be reached
 - which routes are exposed
 - which input data are needed
 - how input data are processed
 - which output data are produced
 - which external actions are triggered

The root object looks like the following:

```javascript
Operation = {
    "url": Resolver | [Resolver],
    "state": String,
    "label": String,
    "needs": String | [String],
    "input": Input | [Input],
    "entryPoints": {Step},
    "index": Step
}
```

Field | Description | Markup
------|-------------|-------
`url` | Describes how this operation can be reached. Can be a single value or an array, but always returned as an array. See the [Resolver](#the-resolver-object) object for more details. | No
`state` | Describes the [publication state](#the-publication-state) of this operation. Possible values are `NOT_PUBLISHED`, `PUBLISHED`, `UNPUBLISHED` and `BLOCKED`. The `PUBLISHED` and `UNPUBLISHED` states can be written, the others are read-only. | No
`label` | Defines an arbitrary name for this operation (generated by default). | No
`needs` | Defines the environment values needed by this operation. TODO: more details needed here. | No
`inputs` | Defines which data is needed globally for this operation. Can be a single value or an array. See the [Input](#the-input-object) object for more details. | No
`entryPoints` | Defines the set of routes implemented by this operation. Each key in the object defines an URL path, to which is associated an arbitrary processing. See the [Step](#the-step-object) object for more details. | No
`index` | Stands as a shortcut for `entryPoints.index`. This is because the `index` step has a special meaning: it is the default step, which is accessed when no entry point is specified in the URL. | No

### The publication state

The publication state controls whether an operation is publicly available or not. This state can have the following values:

State | Description
------|------------
`NOT_PUBLISHED` | The operation has never been published (default).
`PUBLISHED` | The operation is currently published. This is the only state where it can be accessed from the URL(s) defined by its resolver(s).
`UNPUBLISHED` | The operation has already been published, but is not published anymore.
`BLOCKED` | The operation was published, but has been blocked for some reason by an administrator.

## The `Resolver` object

A `Resolver` allows to specify how the operation can be reached. Each resolver basically defines an URL from which the underlying operation is made accessible. Additionally, it is possible to create a typed resolver, which allows to associate one ore more communication media to the access URL.

```javascript
Resolver = String | RawResolver | QrcodeResolver | ImageResolver
```

### Base fields

A `Resolver` generally looks like the following:

```
RawResolver = {
    "host": String,
    "name": String,
    "label": String
}
```

When a resolver is specified as single `String`, it is interpreted as the `name` of a `RawResolver`.

Field | Description | Markup
------|-------------|-------
`host` | Defines the host on which the resolver is created (optional). [Public hosts](#public-hosts) are available by default, but custom domains can be added upon request. | No
`name` | Defines the name of this resolver, which is used as the URL path. | No
`label` | Specifies an arbitrary label for this resolver (optional). | No

### QR code channel

TODO: add general description.

```
QrcodeResolver = RawResolver + {
    "type": "qrcode",
    "design": QrcodeDesign | [QrcodeDesign]
}
```

Field | Description | Markup
------|-------------|-------
`type` | Defines the type of channel (QR code here). | No
`design` | Describes the design(s) of the generated QR code(s). TODO: more details needed here. | No

### Image channel

TODO: add general description.

```
ImageResolver = RawResolver + {
    "type": "image",
    "image": Number | [Number]
}
```

Field | Description | Markup
------|-------------|-------
`type` | Defines the type of channel (image recognition here). | No
`image` | Describes the uploaded image(s) that should be associated to this resolver. TODO: more details needed here. | No

### Public hosts

By default, the following domain names can be used in the `host` field of a resolver:

Domain name | Path prefix | Description
------------|-------------|------------
`e.unitag.io` | `/r` | This is the default domain name, which is used when no `host` is specified.
`opn.to` | `/r` | This is a freely usable white-label domain.

## The `Input` object

TODO

```javascript
Input = {Connector | Input} | [{Connector | Input}]
```

```javascript
Connector = DataConnector | CsvConnector | ...
```

```javascript
DataConnector = Boolean | Number | String | Object | {
    "$data": Boolean | Number | String | Object
}
```

```javascript
CsvConnector = {
    "$csv": String | {
        url: String
    }
}
```

## The `Step` object

TODO

```javascript
Step = RedirectStep | VcardStep | JsonStep | UmeStep |
       SwitchStep | IfStep | GotoStep | TryStep
```

```javascript
BaseStep = {
    "label": String,
    "input": Input | [Input],
    "trigger": Action | [Action]
}
```

```javascript
RedirectStep = String | BaseStep + {
    "redirect": Step
}
```

```javascript
VcardStep = BaseStep + {
    "vcard": Vcard
}
```

```javascript
UmeStep = BaseStep + {
    "ume": Ume
}
```

```javascript
SwitchStep = BaseStep + {
    "switch": Boolean | Number | String | Object,
    "cases": {Step} | [Option],
    "default": Step
}
```

```javascript
IfStep = BaseStep + {
    "if": Boolean
    "then": Step,
    "else": Step
}
```

```javascript
GotoStep = BaseStep + {
    "goto": String
}
```

```javascript
TryStep = BaseStep + {
    "try": Test | [Test],
    "catch": Step,
    "then": Step
}
```
