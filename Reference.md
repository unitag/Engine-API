API Reference
=============

- [Introduction](#introduction)
- [The Operation object](#the-operation-object)
    - [The publication state](#the-publication-state)
- [The Resolver object](#the-resolver-object)
    - [Base fields of resolvers](#base-fields-of-resolvers)
    - [QR code channel](#qr-code-channel)
    - [Image channel](#image-channel)
    - [Public hosts](#public-hosts)
- [The Input object](#the-input-object)
- [The Step object](#the-step-object)
    - [Base fields of steps](#base-fields-of-steps)
    - [The redirection step](#the-redirection-step)
    - [The vCard step](#the-vcard-step)
    - [The U.me step](#the-ume-step)
    - [The switch/cases/default step](#the-switchcasesdefault-step)
    - [The if/then/else step](#the-ifthenelse-step)
    - [The goto step](#the-goto-step)
    - [The try/catch/then step](#the-trycatchthen-step)
- [The Test object](#the-test-object)
- [The Actions object](#the-actions-object)
    - [Base fields of actions](#base-fields-of-actions)
    - [The email action](#the-email-action)
    - [The SMS action](#the-sms-action)
    - [The cookie action](#the-cookie-action)
    - [The upload action](#the-upload-action)
- [Miscellaneous](#miscellaneous)
    - [Predicate testing](#predicate-testing)
    - [The vCard object](#the-vcard-object)

## Introduction

TODO:
 - Lien vers API.md
 - Notions générales
     + [ ] Lien vers la doc de l'API
     + [ ] Publication
     + [ ] Structure des URL d'accès aux opération publiées

A intégrer :

```
       +--> Targets an operation <-+
       |                           |
http://:resolverHost[/:pathPrefix]/:resolverName/:entryPoint
                      |                          |
                      +--> Fixed by the host     +--> Targets an entry point
```

Exemples à placer aux bons endroits :

```json
{
    "url": {
        "host": "opn.to",
        "name": "test"
    },
    "state": "PUBLISHED",
    "index": {
        "json": {
            "body": "Here is the index step"
        }
    },
    "entryPoints": {
        "foobar": {
            "json": {
                "body": "Here is the foobar step"
            }
        }
    }
}
```

## The `Operation` object

An `Operation` is a standalone document describing an HTTP application. It is expressed as a JSON object, which allows to specify:
 - how the application can be reached
 - which routes are exposed
 - which input data are needed
 - how input data are processed
 - which output data are produced
 - which external actions are triggered

The root object looks like the following:

```javascript
Operation = {
    "url": Resolver | [Resolver],
    "state": String,
    "label": String,
    "needs": String | [String],
    "input": Input | [Input],
    "entryPoints": {Step},
    "index": Step
}
```

Field | Description | Markup
------|-------------|-------
`url` | Describes how this operation can be reached. Can be a single value or an array, but always returned as an array. See the [Resolver](#the-resolver-object) object for more details. | No
`state` | Describes the [publication state](#the-publication-state) of this operation. Possible values are `NOT_PUBLISHED`, `PUBLISHED`, `UNPUBLISHED` and `BLOCKED`. The `PUBLISHED` and `UNPUBLISHED` states can be written, the others are read-only. | No
`label` | Defines an arbitrary name for this operation (generated by default). | No
`needs` | Defines the environment values needed by this operation. TODO: more details needed here. | No
`inputs` | Defines which data is needed globally for this operation. Can be a single value or an array. See the [Input](#the-input-object) object for more details. | No
`entryPoints` | Defines the set of routes implemented by this operation. Each key in the object defines an URL path, to which is associated an arbitrary processing. See the [Step](#the-step-object) object for more details. | No
`index` | Stands as a shortcut for `entryPoints.index`. This is because the `index` step has a special meaning: it is the default step, which is accessed when no entry point is specified in the URL. | No

### The publication state

The publication state controls whether an operation is publicly available or not. This state can have the following values:

State | Description
------|------------
`NOT_PUBLISHED` | The operation has never been published (default).
`PUBLISHED` | The operation is currently published. This is the only state where it can be accessed from the URL(s) defined by its resolver(s).
`UNPUBLISHED` | The operation has already been published, but is not published anymore.
`BLOCKED` | The operation was published, but has been blocked for some reason by an administrator.

## The `Resolver` object

A `Resolver` allows to specify how the operation can be reached. Each resolver basically defines an URL from which the underlying operation is made accessible. Additionally, it is possible to create a typed resolver, which allows to associate one ore more communication media to the access URL.

```javascript
Resolver = String | RawResolver | QrcodeResolver | ImageResolver
```

### Base fields of resolvers

A `Resolver` generally looks like the following:

```javascript
RawResolver = {
    "host": String,
    "name": String,
    "label": String
}
```

When a resolver is specified as single `String`, it is interpreted as the `name` of a `RawResolver`.

Field | Description | Markup
------|-------------|-------
`host` | Defines the host on which the resolver is created (optional). [Public hosts](#public-hosts) are available by default, but custom domains can be added upon request. | No
`name` | Defines the name of this resolver, which is used as the URL path. | No
`label` | Specifies an arbitrary label for this resolver (optional). | No

### QR code channel

TODO: add general description.

```javascript
QrcodeResolver = RawResolver + {
    "type": "qrcode",
    "design": QrcodeDesign | [QrcodeDesign]
}
```

Field | Description | Markup
------|-------------|-------
`type` | Defines the type of channel (QR code here). | No
`design` | Describes the design(s) of the generated QR code(s). TODO: more details needed here. | No

### Image channel

TODO: add general description.

```javascript
ImageResolver = RawResolver + {
    "type": "image",
    "image": Number | [Number]
}
```

Field | Description | Markup
------|-------------|-------
`type` | Defines the type of channel (image recognition here). | No
`image` | Describes the uploaded image(s) that should be associated to this resolver. TODO: more details needed here. | No

### Public hosts

By default, the following domain names can be used in the `host` field of a resolver:

Domain name | Path prefix | Description
------------|-------------|------------
`e.unitag.io` | `/r` | This is the default domain name, which is used when no `host` is specified.
`opn.to` | `/r` | This is a freely usable white-label domain.

## The `Input` object

TODO

```javascript
Input = {Connector | Input} | [{Connector | Input}]
```

```javascript
Connector = DataConnector | CsvConnector | ...
```

```javascript
DataConnector = Boolean | Number | String | Object | {
    "$data": Boolean | Number | String | Object
}
```

```javascript
CsvConnector = {
    "$csv": String | {
        url: String
    }
}
```

## The `Step` object

TODO

```javascript
Step = RedirectStep | VcardStep | JsonStep | UmeStep |
       SwitchStep | IfStep | GotoStep | TryStep
```

### Base fields of steps

```javascript
BaseStep = {
    "label": String,
    "input": Input | [Input],
    "trigger": Actions | [Actions]
}
```

### The redirection step

```javascript
RedirectStep = String | BaseStep + {
    "redirect": Step
}
```

### The vCard step

```javascript
VcardStep = BaseStep + {
    "vcard": Vcard
}
```

### The U.me step

```javascript
UmeStep = BaseStep + {
    "ume": Ume
}
```

### The `switch`/`cases`/`default` step

```javascript
SwitchStep = BaseStep + {
    "switch": Boolean | Number | String | Object,
    "cases": {Step} | [Option],
    "default": Step
}
```

### The `if`/`then`/`else` step

```javascript
IfStep = BaseStep + {
    "if": Boolean,
    "then": Step,
    "else": Step
}
```

### The `goto` step

```javascript
GotoStep = BaseStep + {
    "goto": String
}
```

### The `try`/`catch`/`then` step

```javascript
TryStep = BaseStep + {
    "try": Test | [Test],
    "catch": Step,
    "then": Step
}
```

## The `Test` object

```javascript
Test = {
    "enabled": Boolean,
    "label": String,
    "input": Input | [Input],
    "trigger": Actions | [Actions],
    "value": Boolean | Number | String | Object,
    "assert": Boolean | Number | String | Assertion | [Assertion],
    "catch": Step
}
```

## The `Actions` object

```javascript
Actions = {
    "enabled": Boolean,
    "logged": Boolean,
    "waited": Boolean,

    "email": EmailAction | [EmailAction],
    "sms": SmsAction | [SmsAction],
    "cookie": CookieAction | [CookieAction],
    "upload": UploadAction | [UploadAction]
}
```

### Base fields of actions

```javascript
BaseAction = {
    "output": String,
    "logged": Boolean,
    "waited": Boolean
}
```

### The email action

```javascript
EmailAction = BaseAction + {
    "from": String | [String] | Object | [Object],
    "to": String | [String] | Object | [Object],
    "subject": Boolean | Number | String | Object,
    "body": Boolean | Number | String | Object,
    "attachment": Attachment | [Attachment]
}
```

```javascript
Attachment = {
    "text": TextAttachement | [TextAttachement],
    "vcard": Vcard | [Vcard],
    "upload": File | [File]
}
```

```javascript
TextAttachement = String | {
    "filename": String,
    "content": String
}
```

### The SMS action

```javascript
SmsAction = Action + {
    "destination": String,
    "text": Boolean | Number | String | Object
}
```

### The cookie action

```javascript
CookieAction = Action + {
    "key": Boolean | Number | String,
    "value": Boolean | Number | String | Object,
    "age": Number
}
```

### The upload action

```javascript
UploadAction = Action + {
    "file": String | File,
    "alterations": [Alteration]
}

File = {
    "path": String,
    "filename": String,
    "contentType": String
}

Alteration = /TODO/
```

## Miscellaneous

### Predicate testing

```javascript
Predicate = {
    "eq": Boolean | Number | String | Object,
    "ne": Boolean | Number | String | Object,
    "lt": Boolean | Number | String | Object,
    "gt": Boolean | Number | String | Object,
    "lte": Boolean | Number | String | Object,
    "gte": Boolean | Number | String | Object

    // Other tests
}
```

### The vCard object

```javascript
Vcard = /TODO/
```
